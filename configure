#!/bin/sh

makefiles="Makefile bt/Makefile implode/Makefile itsfs/Makefile qcam/Makefile states/Makefile tags.make/Makefile tags.view/Makefile treesync/Makefile threads/Makefile"

precomps="pf_frontend myshell myshell-launcher inst"

if [ "x$1" = x--tar ] ; then
    if [ "x$2" = x ] ; then
	echo must specify version as 2nd arg
	exit 1
    fi
    ./configure --clean
    cd ..
    tar cf pkutils${2}.tar pkutils${2}
    gzip -9 pkutils${2}.tar
    exit 0
fi

if [ "x$1" = x--clean ] ; then
    [ -f Makefile ] && make clean
    cd pdksh-5.2.14 && make distclean  2> /dev/null
    rm -f ksh_precrunch.o
    cd ..
    find . -name \*~ -print | xargs rm -f
    rm -f main.h
    exit 0
fi

ARCH=`uname -s`-`uname -r`
EXE_NAME=0

case $ARCH in
    FreeBSD-*)
	def=freebsd
	awk=awk
	;;
    SunOS-5*)
	def=solaris
	awk=gawk
	;;
    SunOS-4*)
	def=sunos
	awk=gawk
	;;
    CYGWIN_NT-*|CYGWIN_98-*)
	def=cygwin32
	awk=gawk
# cygwin's $ARCH is ugly and complex. simplify it!
	ARCH=cygwin32
	EXE_NAME=1
	;;
    *)
	echo "unknown arch $ARCH, please modify configure and Makefile.in's"
	exit 1
	;;
esac

echo configuring for $ARCH, Makefile.in opt is $def

IFDEFSYM=$def
export IFDEFSYM

for f in $makefiles ; do
    rm -f $f
    $awk -f configure.awk < $f.in > $f
done

$awk -f configure.awk < main.h.in > main.h.tmp

# man solaris sh sucks!  you can't do 'if ! <cmd>'   !

if cmp main.h.tmp main.h ; then
    echo main.h is unchanged
    rm -f main.h.tmp
else
    mv -f main.h.tmp main.h
    chmod a-w main.h
fi

rm -f $precomps
for f in $precomps ; do
    rm -f $f
    (
        head -1 ${f}.in
        echo ''
        echo '#'
        echo '# do not edit this file....'
        echo '# this file is autogenerated.'
        echo '# please edit the master and rerun ./configure!'
        echo '#'
        echo ''
        sed -e 1d -e s/MY_USERNAME/$USER/g -e s/MY_ARCH/$ARCH/g < ${f}.in
    ) > $f
    chmod a-w $f
done
chmod u+x inst

echo '#define ADMINNAME "pkutils"' > main_prog.h.tmp

if cmp main_prog.h.tmp main_prog.h ; then
    echo main_prog.h unchanged
    rm -f main_prog.h.tmp
else
    mv -f main_prog.h.tmp main_prog.h
fi

my_uid=`id | sed -e 's/^uid=\([0-9][0-9]*\).*$/\1/'`
echo '#define MY_UID' $my_uid > sudo.h.tmp

my_gid=`id | sed -e 's/.* gid=\([0-9][0-9]*\).*$/\1/'`
echo '#define MY_GID' $my_gid >> sudo.h.tmp

if cmp sudo.h.tmp sudo.h ; then
    echo sudo.h unchanged
    rm -f sudo.h.tmp
else
    mv -f sudo.h.tmp sudo.h
fi

make depend
find . -name Makefile | xargs chmod a-w

exit 0
