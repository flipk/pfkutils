#!/bin/sh

prefix=@prefix@
compile=@PFK_FINDPF_GCC@
compileargs="@PFK_FINDPF_GCC_ARGS@"

# gross: cygwin puts slashes and parens in the revision string!

os=`uname -s`
rev=`uname -r | sed -e 's,/,_,g' -e 's,[(|)],_,g'`
pf=$os-$rev

# note -d will return true if a symlink points to a dir
#         which is what we want
if ! [ -d "${prefix}/${pf}" ] ; then
    echo '!!!! NOTE:' PFKARCH=${pf} 'is not found! searching !!!!' 1>&2

    findpfsrc=${prefix}/src/find-pfk-pf.c
    findpfbin=${prefix}/bin/find-pfk-pf
    buildlog=${HOME}/find-pfk-pf-compile.log

    rm -f ${findpfbin}
    $compile $compileargs \
             ${findpfsrc} -o ${findpfbin} \
             > ${buildlog} 2>&1
    chmod 600 ${buildlog}
    if [ -x ${findpfbin} ] ; then
        pf_old="${pf}"
        pf=$( ${findpfbin} "${prefix}" "${pf}" )
        echo '!!!! NOTE: FOUND' PFKARCH=${pf} 1>&2
        echo '!!!! NOTE: consider running the following commands:' 1>&2
        echo '     cd pfk' 1>&2
        echo '     ln -s' ${pf} ${pf_old} 1>&2
    fi
fi

echo $pf

exit 0
