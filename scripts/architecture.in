#!/bin/sh

prefix=@prefix@
compile=@PFK_FINDPF_GCC@
compileargs="@PFK_FINDPF_GCC_ARGS@"

# gross: cygwin puts slashes and parens in the revision string!

os=`uname -s`
rev=`uname -r | sed -e 's,/,_,g' -e 's,[(|)],_,g'`
pf=$os-$rev

pf_real="unset PFKARCH_REAL"

# note -d will return true if a symlink points to a dir
#         which is what we want
if ! [ -d "${prefix}/${pf}" ] ; then
    echo '!!!! NOTE:' PFKARCH=${pf} 'is not found! searching !!!!' 1>&2

    findpfsrc=${prefix}/src/find-pfk-pf.c
    findpfbin=${prefix}/bin/find-pfk-pf
    buildlog=${HOME}/find-pfk-pf-compile.log

    rm -f ${findpfbin}
    $compile $compileargs \
             ${findpfsrc} -o ${findpfbin} \
             > ${buildlog} 2>&1
    chmod 600 ${buildlog}
    if [ -x ${findpfbin} ] ; then
        pf_old="${pf}"
        pf=$( ${findpfbin} "${prefix}" "${pf}" )
        echo '!!!! NOTE: FOUND' PFKARCH=${pf} 1>&2
        echo '!!!! NOTE: consider running the following command:' 1>&2
        echo '     makepflink' 1>&2
        pf_real=PFKARCH_REAL=${pf_old}
    fi
fi

if [ "x$1" = x-e ] ; then
    echo PFKARCH=$pf $pf_real
else
    echo $pf
fi

exit 0
